### WaterSrot

> U: Uniform 等长  </br>
> LS: LongShort 长短试管  </br>
> P:  Prop 道具 

|     | 不带道具 | 带道具 |
|:---:|:----:|:---:|
| 等长  | UNP  | UP  |
| 长短  | LSNP | LSP |
| 不等长 | NUNP | NUP |

上述一共6总类型的关卡

### 等长关卡变体

|                      |      等长试管       | 实现情况 |
|:--------------------:|:---------------:|:----:|
|      capacity:4      |      常规关卡       | 已实现  |
|      capacity:3      |       短试管       | 已实现  |
|   capacity: 6 or 8   |       长试管       | 已实现  |
|        液面高度错落        |       造型关       | 已实现  |    
| mul-color：capacity：3 | 存在液体高度：6，试管容量：3 |  暂无  |  



----------------------------
### 道具介绍

|     道具/作用维度     |      倒入      | 倒出 | 顶部边界 |                            其他                            |      解锁/触发条件      |       作用效果        |
|:---------------:|:------------:|:--:|:----:|:--------------------------------------------------------:|:-----------------:|:-----------------:|
|       问号        |      -       | -  |  ✅   |                            -                             | 初始存在，暴露后解锁，显示实际颜色 |       隐藏液体        |
|       固定        |      -       | ✅  |  -   |                       可指定为tbs中gc部分                       |       一直生效        |     瓶子固定，不可倒出     |
|       帷幕        |      ✅       | ✅  |  -   |                     fc = h && gc = 0                     |   完成帷幕颜色即可揭开帷幕    |   盖住瓶子，未揭开前，不可用   |
|       专属        | ✅ </br>限特定颜色 | -  |  -   |                          gc + h                          |       一直生效        | 特定颜色专属瓶，只接受特定颜色液体 |
|     石膏(牛皮纸)     |✅| ✅  |  -   |       1. 两边 tbs = 0 </br> 2. 存在c完成 </br> 3.有多余的单色瓶       |      旁边的瓶子完成      |     未解锁前不能使用      |
|      钥匙-锁       | ✅| ✅  |  -   | 1. 对应的锁的颜色区间释放. </br> 2. 二选一。a. gc - fc >= 锁到瓶子顶部的差；？待完善 |    对应钥匙释放即可解锁     |    锁住的瓶子暂时不能使用    |
|   冰盒（连体瓶子冻结)    | ✅| -  |  -   |                    >=2 一行连续的瓶子冻结成一个冰盒                    |  冰盒中的某个瓶子完成即可解锁   |    冰盒内的瓶子只允许倒入    |
| 磁铁</br>（确定后续会上） |      -       | -  |  -   |                            ✅                             |    初始存在，暴露后生效     |  磁铁暴露后，吸引同色液体聚集   |


---- 

### 各种类型关卡的出题，解题，路径获取方式
|    关卡类型\出解题方式     | 出题                                             | 解题                           | 解题路径获取方式           |
|:-----------------:|:-----------------------------------------------|:-----------------------------|:-------------------|
|  UNP <br> 等长不带道具  | a: 随机字符串出题 </br> b: 选定构型组染色                    | a：完全TBS解题                    | a: 根据TBS解题路径解析完整路径 |
|   UP <br> 等长带道具   | a: 分析UNP TBS路径 <br> 可得到[问号][固定][帷幕]道具的方案       | a: TBS作为启发函数，</br> 紧凑化较少状态节点 | a: 解题即可得完整路径       |
| LSNP <br> 长短不带道具  | a: 随机字符串出题，调整空瓶容量 </br> b: 选定构型出题，调整空瓶容量 </br> | a: TBS作为启发函数，</br> 紧凑化较少状态节点 | a: 解题即可得完整路径       |
|  LSP <br> 长短带道具   | a: 分析LSNP解题路径，获取对应道具的方案                        | a: TBS作为启发函数，</br> 紧凑化较少状态节点 | a: 解题即可得完整路径       |
| NUNP <br> 不等长不带道具 | 暂无完整实现思路，完成条件：盘面只存在满或空单色管                      | 暂无                           | 暂无                 |
|  NUP <br> 不等长带道具  | 暂无                                             | 暂无                           | 暂无                 |

---- 
### 基础维度
- 失败率
- 失败位置
- 难度值
  - 与上一步移动的曼哈顿距离相关
  - 移动后，接水瓶的状态
  - 目前问题：存在体感难度很大，难度较低的情况 （待解决）
    - 猜测：一个盘面的同批量移动，移动与移动的权重不同，或者偏好不同，需要把这个考虑进入
    - 尝试使用移动的反直觉指数描述，移动的反直觉指数不仅由自身确定，还要考虑他在同批量移动中的反直觉指数
    - 由同批量的移动中排序，根据这个确认这个移动的反直觉指数
### 体验维度 （待验证）
- 移动的顺手度：移动的方向以及步幅 （单步移动）
- 多次移动的衔接度：多次移动是否成链 （连续移动步数）
- 色块整齐度：盘面 + 摆放布局 => 计算色块区域个数
  - 色块越少，颜色越整齐
  - 对于同一个关卡，仅调整瓶子的摆放位置，即可对视觉体验有较大的观感提升

### 待验证的维度
- 构建最小状态图
    - 最小状态即所有等价盘面用同一个状态表示，这次用顶部边界表来表示最小状态的节点
    - 构建以顶部边界表为顶点，移动的瓶子为边的状态图 
- 统计失败叶子节点数，成功叶子节点数
- 致死移动 
  - 失败节点往父节点向上溯源，找到第一个有分支的节点，该节点指向失败路径的移动为致死移动
- 致死步数 
  - 失败节点向上需要找到致死移动的节点数
- 致死点 
  - 从初始盘面到致死分叉盘面的步数
- 致死率 
  - 所有致死移动发生的概率之和 
  - 致死移动发生概率 = 到致死分叉盘面的概率 * 选择致死移动的概率
- 连续移动步数 
  - 连续移动：在一次有效的倒入操作中，其起始试管或目标试管，与前一次操作的起始试管或目标试管至少有一个是相同的。
  - 分析在可解路径上的连续移动步数分布

### 重要理解
水排序的等价盘面 本质的 强连通分量
特殊：
在 UNP 中，可以使用 顶部边界表直接表达强连通分量
在 UP 中, 在原先顶部边界表的基础上，有些边应为道具的原因造成了不能互相可达

效率提升的关键
1. 如何表达强连通分量
2. 如何表达 已强连通分量为边的 移动

多层次，分类处理
在 U系列中，原先的条件变为 充分条件


不等长的强连通分量处理还需斟酌

### 组件
需要整体性的重新梳理各个部分的逻辑
[//]: # (- TBS工具)

[//]: # (- 移动生成器 MoveGenerator)

[//]: # (- 移动执行器 MoveExecutor)

[//]: # (- TBS路径解析 TBSPathParser)

[//]: # ()
[//]: # (- 道具更新器 PropUpdater)

[//]: # (- 移动选择器 MoveSelector)

[//]: # (- )