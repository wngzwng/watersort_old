> U: Uniform ç­‰é•¿  </br>
> LS: LongShort é•¿çŸ­è¯•ç®¡  </br>
> P:  Prop é“å…·


### æ±‚è§£
##### 1. UNP å…³å¡æ±‚è§£   TBS
##### 2. UP å…³å¡æ±‚è§£   TBSå¾®è°ƒ
- å¸·å¹•ï¼šå®Œæˆç‰¹å®šé¢œè‰² c
  - tbså®Œæˆæ¡ä»¶ï¼š F_c = h && G_c = 0
- æœºæ¢°è‡‚-å›ºå®šï¼šåªèƒ½æ¥å—ï¼Œä¸èƒ½å€’å‡º
  - a. æœªå€’å…¥é¢œè‰²ï¼Œåˆ™æŒ‡å®šé¢œè‰²ï¼Œä½œä¸ºåˆå§‹çŠ¶æ€ï¼›ã€æœ‰å‡ ç§é¢œè‰²ï¼Œå°±æœ‰å‡ ç§åˆå§‹çŠ¶æ€ã€‘
  - b. æœ‰å€’å…¥é¢œè‰²ï¼Œåˆ™æŒ‡å®šä¸ºå·²ç»å€’å…¥çš„é¢œè‰²
  - tbsæ–¹å¼ï¼šæœºæ¢°è‡‚ä½œä¸ºæŒ‡å®šé¢œè‰²çš„ G_c çš„æ‰©å……ç©ºé—´
- çŸ³è†ï¼šæ—ä¾§æœ‰å®Œæˆå±å³å¯è§£é”ï¼ˆæ—ä¾§éœ€è¦å¸ƒå±€æ¥ç¡®å®šï¼Œæ— å¸ƒå±€é»˜è®¤ä¸¤æ—ï¼‰
  - tbsæ–¹å¼ï¼š
    - æ—ä¾§ tbs = 0
    - æœ‰é¢œè‰²å®Œæˆ
    - å­˜åœ¨ä¸€ä¸ªç©ºç“¶ï¼ˆç”¨æ¥è½¬ç§»åˆ°å®Œæˆå±åˆ°çŸ³è†æ—ä¾§ï¼‰
- é’¥åŒ™å’Œé”ï¼š é’¥åŒ™æ‰€åœ¨æ¶²ä½“æš´éœ²è·å¾—ï¼Œç„¶åè§£é”é”
  - ç¡®å®šé’¥åŒ™æ‰€åœ¨çš„é¢œè‰²æ®µï¼ˆç”¨äºé’¥åŒ™æ‰€åœ¨é¡¶éƒ¨è¾¹ç•Œçš„åˆ¤å®šï¼‰
  - é’¥åŒ™è·ç¦»ç“¶é¡¶çš„é«˜åº¦ diff-h
  - é’¥åŒ™ä¸Šæ–¹å¯èƒ½æœ‰åŒè‰²æ¶²ä½“æ•°é‡  diff-old-boundary
  - tsbï¼š
    - G_c - F_c == diff-h çš„æƒ…å†µä¸‹ï¼š
      - åŒè‰²æ¶²ä½“å±€éƒ¨è½¬ç§»å¯è·å¾—é’¥åŒ™
    - å…¶ä½™æƒ…å†µï¼šè¯¥é¡¶éƒ¨è¾¹ç•Œä¸‹é™å³å¯è·å¾—é’¥åŒ™
- ä¸“å±é¢œè‰²: åªæœ‰ç‰¹å®šé¢œè‰²å¯æ”¾å…¥
  - tsb: å¯¹åº”é¢œè‰² G_c + h 
#### 3. é€šç”¨æ±‚è§£å™¨
- ç›®æ ‡ï¼š æ¯æ¬¡ç§»åŠ¨éƒ½æ¨è¿›çŠ¶æ€ or ç´§å‡‘åŒ–æ“ä½œ
- è½¬å˜ï¼š æ¯æ¬¡ä¸åœ¨ä»¥ç§»åŠ¨ä¸€æ¬¡ä½œä¸ºè¾¹ï¼Œè€Œæ˜¯æ¨åŠ¨çŠ¶æ€å˜åŒ–çš„ç§»åŠ¨ç»„ä¸ºè¾¹
- çµæ„Ÿï¼š 
  - é¡¶éƒ¨è¾¹ç•Œè¡¨çš„æ¨è¿›ä¸€å®šä¼šå¯¼å‘ä¸€ä¸ªæ–°çš„çŠ¶æ€
  - åŒç±»å‹å•è‰²ç“¶èšåˆ ç”¨äºç´§å‡‘åŒ–ï¼Œå±äºå®é™…è¿‡ç¨‹çš„è¿‡æ¸¡æˆ–è€…è§„æ•´ï¼ˆèšåˆè§„åˆ™ç­–ç•¥åŒ–ï¼‰
  - ä¸åŒç±»å‹å•è‰²ç“¶çš„è½¬ç§»æˆ–æˆ–è€…èšåˆ ä¹Ÿä¼šå¯¼å‘æ–°çš„çŠ¶æ€
    - ä¸åŒç±»å‹çš„å•è‰²ç“¶ï¼š
      - é«˜åº¦ä¸åŒçš„å•è‰²ç“¶
      - è¯­ä¹‰ä¸åŒçš„å•è‰²ç“¶ï¼ˆæ­£å¸¸å•è‰²ç“¶å’ŒçŸ³è†ç›˜é¢çš„å•è‰²ç“¶ï¼‰
      - å«æœ‰æŒç»­è§¦å‘çš„å•è‰²ç“¶
    
- æ¯æ¬¡è½¬ç§»éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡å¯èƒ½å¼•èµ·çŠ¶æ€å˜åŒ–çš„ç§»åŠ¨ç»„

```c#
public record TubeMoveAvailability(
    int TubeIndex,
    int Color,
    int ExportCount, // è¯¥é¢œè‰²å¯ä»æ­¤ç“¶å€’å‡ºçš„æ•°é‡
    int AcceptCount // è¯¥é¢œè‰²å¯è¢«æ­¤ç“¶æ¥æ”¶çš„æ•°é‡
);

enum MoveGroupKind
{
    AdvanceBoundary,    // è¾¹ç•Œæ¨è¿›å‹
    NormalizeMonochrome,  // ç´§å‡‘åŒ– / è§„æ•´å‹ åŒç±»å‹å•è‰²ç“¶èšåˆ
    MergeMonochrome,
    TransformSemantic
}

// åˆ†å±‚æ¢ç´¢
static readonly MoveGroupKind[] ExploreOrder =
{
    MoveGroupKind.AdvanceBoundary,
    MoveGroupKind.MergeMonochrome,
    MoveGroupKind.TransformSemantic,
    MoveGroupKind.NormalizeMonochrome
};

IEnumerable<MoveGroup> GenerateMoveGroups(State state)
{
    var availability = ScanAvailability(state);
    var (froms, tos) = Partition(availability);

    var result = new List<MoveGroup>();

    foreach (var kind in ExploreOrder)
    {
        var groups = ExploreLayer(kind, state, froms, tos);
        result.AddRange(groups);
    }

    return result;
}

IEnumerable<MoveGroup> ExploreLayer(
    MoveGroupKind kind,
    State state,
    IEnumerable<FromTube> froms,
    IEnumerable<ToTube> tos)
{
    foreach (var from in froms)
    {
        var toCandidates = ExtractToTubes(kind, from, tos);

        if (TryGetMoveGroup(kind, from, toCandidates, out var group))
        {
            yield return group;
        }
    }
}
```
```text 
State
  â†“
Explore â†’ MoveGroupï¼ˆåªå«çœŸå®çŠ¶æ€å˜åŒ–ï¼‰ è¿™é‡Œæ¶‰åŠåˆ°MoveGroupçš„ç±»å‹ï¼Œä¼˜å…ˆçº§å’Œåˆ†å±‚æ¢ç´¢
  â†“
Apply
  â†“
Normalizeï¼ˆèšåˆç­‰ä»·ç±»ï¼‰// åŒç±»å‹å•è‰²ç“¶å­çš„èšåˆ åŒç±»å‹ï¼ˆé«˜åº¦ï¼Œé“å…·çŠ¶æ€ä¸€è‡´ï¼‰
  â†“
Hash / Visited / Queue   Hash è§„åˆ™ï¼šè¦æœ‰æ´¾åˆ©(éå•è‰²ç“¶ï¼ˆé¡ºåºæ’åºï¼‰ï¼Œå•è‰²ç“¶ï¼ˆæŒ‰ç…§ï¼ˆæœ‰æ— é“å…·ï¼Œä»¥åŠ(TubeColorAvailabilityï¼‰æ’åº

è¿™ä¸ªæ˜¯hashçš„å…·ä½“è¡¨ç°
// å¦‚æœå¤šä¸ªå•è‰²ç“¶ï¼ˆåŒé¢œè‰²ã€åŒé«˜åº¦ã€åŒè¯­ä¹‰ç±»å‹ï¼‰å½¼æ­¤å¯äº¤æ¢è€Œä¸å½±å“æœªæ¥å¯è¾¾æ€§ï¼š
æŠŠå®ƒä»¬æŒ‰ (Color, Height, Type, ...) æ’åº
æˆ–æŠŠå®ƒä»¬èšåˆ°å›ºå®šåŒºé—´ï¼ˆä½†å¿…é¡»æ˜¯ç¡®å®šæ€§çš„ï¼‰

Normalize çš„ä¸¤ç§ç±»å‹ï¼ˆæ­£å¼å®šä¹‰ï¼‰
Normalize-1ï¼šä½ç½®åŒæ„è§„çº¦ï¼ˆPermutation Equivalenceï¼‰

æœ¬è´¨ï¼šä½ç½®é€ æˆçš„çŠ¶æ€åŒæ„

å¤„ç†å±‚çº§ï¼šHash / Key

æ˜¯å¦æ”¹å˜ Stateï¼šâŒ ä¸æ”¹å˜

æ˜¯å¦äº§ç”Ÿè¾¹ï¼šâŒ ä¸æ˜¯ MoveGroup

ä½œç”¨ï¼šåˆ¤é‡ / å»å¯¹ç§°

âœ” åªåœ¨ Key å±‚å¤„ç†
âœ” ä¸è¿›å…¥æœç´¢è¯­ä¹‰

Normalize-2ï¼šåŒç±»å‹å•è‰²ç“¶èšåˆç­‰ä»·

æœ¬è´¨ï¼šåŒç±»å‹å•è‰²ç“¶ä¹‹é—´çš„â€œç»“æ„ç­‰ä»·æ€â€

å¤„ç†å±‚çº§ï¼šå…¥é˜Ÿå‰ State è§„çº¦

æ˜¯å¦æ”¹å˜ Stateï¼šâš ï¸ æ”¹å˜ State è¡¨ç¤ºï¼Œä½†ä¸æ”¹å˜çŠ¶æ€è¯­ä¹‰

æ˜¯å¦äº§ç”Ÿè¾¹ï¼šâŒ ä¸æ˜¯ MoveGroup

ä½œç”¨ï¼šå‡å°‘çŠ¶æ€æ•°é‡ / ç¨³å®šæœç´¢

âœ” åœ¨ Apply åã€å…¥é˜Ÿå‰æ‰§è¡Œ
âœ” æ”¹å˜çš„æ˜¯â€œçŠ¶æ€è¡¨ç¤ºâ€ï¼Œä¸æ˜¯â€œé—®é¢˜çŠ¶æ€â€

State (çœŸå®ç‰©ç†çŠ¶æ€)
   â†“
Explore â†’ MoveGroupï¼ˆåªæ˜¯çœŸå®çŠ¶æ€å˜åŒ–ï¼‰
   â†“
Apply â†’ NewState
   â†“
Normalize-2ï¼ˆåŒç±»å‹å•è‰²ç“¶èšåˆï¼‰
   â†“
BuildHashKeyï¼ˆåŒ…å« Normalize-1 çš„ä½ç½®è§„çº¦ï¼‰
   â†“
Visited / Enqueue
éå¸¸é‡è¦çš„ä¸€ç‚¹ï¼š
ğŸ‘‰ HashKey çš„è®¡ç®—è¾“å…¥ï¼Œæ°¸è¿œæ˜¯ Normalize-2 ä¹‹åçš„ State

ä½ å·²ç»æ˜ç¡®è¯´äº†è¿™ä¸€å¥ï¼Œæˆ‘å†å¸®ä½ å¼ºè°ƒä¸€æ¬¡ã€‚

```
```text 
âœ… Normalize-2ï¼ˆå…è®¸ï¼‰

æ‰€æœ‰ç“¶å­ ç±»å‹ç›¸åŒ

æ‰€æœ‰ç“¶å­ é¢œè‰²ç›¸åŒ

æ‰€æœ‰ç“¶å­ å•è‰²

ä¸å‘ç”Ÿé¢œè‰²è·¨ç“¶è¿ç§»

åªæ˜¯æŠŠå¤šä¸ªâ€œåŒæ„ç“¶â€æ˜ å°„åˆ°ä¸€ä¸ªç»Ÿä¸€ç»“æ„å¸ƒå±€

æ”¹å˜çš„æ˜¯ï¼š

è¡¨ç¤ºæ–¹å¼

å®¹å™¨ç¼–å· / åˆ†å¸ƒå½¢å¼

ä¸æ”¹å˜çš„æ˜¯ï¼š

æ¯ä¸ªé¢œè‰²çš„æ€»ä½“åˆ†å¸ƒèƒ½åŠ›

åç»­å¯è¾¾ MoveGroup é›†åˆ

âŒ MergeMonochromeï¼ˆå¿…é¡»æ˜¯ MoveGroupï¼‰

æ»¡è¶³ä»»æ„ä¸€æ¡å³åˆ¤ä¸º Mergeï¼š

ä¸åŒç±»å‹çš„å•è‰²ç“¶

èšåˆå¯¼è‡´æŸç“¶é«˜åº¦å‘ç”Ÿå˜åŒ–

èšåˆå‰åå¯ç”¨ MoveGroup é›†åˆä¸åŒ

èšåˆå¼•å‘æ–°çš„è¾¹ç•Œæ¨è¿› / è¯­ä¹‰è½¬å˜
```

```text
ä¸ï¼Œä¸èƒ½æ˜¯åˆ†ææœ€ç»ˆçš„ç»“æœè¾¹ï¼Œåº”ä¸ºåªçŸ¥é“è¾¹ï¼Œä½†å¹¶ä¸æ¸…æ¥šè¾¹çš„ç”±æ¥
åº”è¯¥æ˜¯æŠŠåˆ†ç»„ç»™ä»–

1. æœ€åŸå§‹çš„åˆ†ç»„ï¼Œéå•è‰²ç“¶ï¼Œ å•è‰²ç“¶
2. ç§»åŠ¨èƒ½åŠ› { tube_idnex, export_color, export_count, accect_count, accect_color}

è¿™æ ·èƒ½ä¸èƒ½å€’å‡ºå’Œæ¥å—ï¼Œé€šè¿‡ export_countï¼Œ accect_color å¯è¡¨ç°å‡ºæ¥
å¯ä»¥å€’å‡ºä»€ä¹ˆé¢œè‰²å’Œæ¥å—ä»€ä¹ˆé¢œè‰²ï¼šexport_color, å·²ç» accect_color è¡¨ç°å‡ºæ¥

1. ç§»åŠ¨èƒ½åŠ›ç»è¿‡ é“å…·æ‹“å±•å½±å“ =ã€‹ æ–°çš„ç§»åŠ¨èƒ½åŠ›

2. åˆ†ç»„ï¼š fromç»„ï¼Œ ä»¥åŠ toç»„

3. å¦‚ä½• æ ¹æ®fromç»„ä»¥åŠtoç»„ç”Ÿæˆç§»åŠ¨ç§»åŠ¨ç»„ï¼Œè¿™ä¸ªæœ‰å¤–éƒ¨æ³¨å†Œçš„ IMoveGroupExplorer äº§ç”Ÿ
å½“ç„¶è¿™ä¸ªæœ‰é»˜è®¤å®ç°ï¼ˆå¦‚æœå¤–éƒ¨ä¸æ³¨å…¥çš„è¯ï¼‰ 


ç§»åŠ¨èƒ½åŠ›
public record TubeMoveAvailability(
    int TubeIndex,
    int ExportColor,
    int ExportCount, // è¯¥é¢œè‰²å¯ä»æ­¤ç“¶å€’å‡ºçš„æ•°é‡
    int AcceptCount, // è¯¥é¢œè‰²å¯è¢«æ­¤ç“¶æ¥æ”¶çš„æ•°é‡
    int AcceptColor,
    TubeStructuralKey StructuralKey,
    Object? extra
);

record TubeStructuralKey(
    int Capacity,
    bool IsMonochrome,
    TubeKind Kind // Normal / Mono / SpecialMono / Fixed / ...
);
 
// ç“¶å­é“å…·çš„ï¼Œ ç“¶å­ç±»å‹ï¼Œ å“ªç§æ‹¥æœ‰å…³å¡çº§åˆ«çš„å½±å“è§„åˆ™çš„ï¼Œå°±åº”è¯¥æ˜¯ç“¶å­ç±»å‹

enum TubeKink
{

}

// ä¸å¥½
enum TubeEffect  ç“¶å­æ•ˆæœ
{

}

enum SlotEffect æ ¼å­æ•ˆæœ

å¥½ï¼š
enum EffectTargetKink
{
    Tube,
    Slot
}

5ï¸âƒ£ é“å…·ä½œç”¨çš„ä½ç½®ï¼ˆScope / Positionï¼‰

è¿™æ˜¯ Target çš„å®ä¾‹åŒ–ã€‚

æ­£ç¡®å»ºæ¨¡æ–¹å¼
record EffectScope {
    EffectTargetKind TargetKind;
    int TubeIndex;
    int? SlotHeight; // ä»…å½“ TargetKind == Slot
}

interface IEffect {
    EffectTargetKind TargetKind { get; }
    EffectPhase Phase { get; }

    void Apply(
        EffectScope scope,
        CapabilityBuilder builder,
        EffectContext ctx
    );
}

Effect åšçš„äº‹åªæœ‰ä¸€ä»¶ï¼š

æŠŠâ€œä¸Šä¸‹æ–‡ + ç»“æ„ + è§„åˆ™â€ï¼ŒæŠ˜ç®—æˆ Capability çš„å˜åŒ–


äºŒã€TubeKind çš„ç¬¬ä¸€ä¸ªæ³¨å…¥ç‚¹ï¼šåŸºç¡€èƒ½åŠ›ç”Ÿæˆ
ğŸ“ æ³¨å…¥ä½ç½®

ğŸ‘‰ BaseCapabilityProvider / ComputeBaseAvailability

è¿™æ˜¯ä½ ç³»ç»Ÿä¸­å”¯ä¸€ä¸€ä¸ªâ€œå¯ä»¥ç†è§£ TubeKind è¯­ä¹‰â€çš„åœ°æ–¹ã€‚

èƒ½åŠ›æµæ°´çº¿å›é¡¾
TubeKind + TubeState
        â†“
BaseCapabilityProvider
        â†“
TubeMoveAvailability (base)
        â†“
[é“å…· Effect ä¿®æ”¹]

// èƒ½åŠ›æ¥æº
enum CapabilitySource {
    BaseRule,
    PowerUp,
    TemporaryEffect
}

IAvailabilityProviderï¼ˆåŸºç¡€ + é“å…·ï¼‰

IAvailabilityTransformerï¼ˆé“å…·å åŠ ï¼‰

IMoveGroupExplorerï¼ˆç»„åˆ from / toï¼‰

è€Œ Core åªéœ€è¦åšä¸€ä»¶äº‹ï¼š

æŠŠ availability æµæ°´çº¿è·‘å®Œï¼Œç„¶åäº¤å‡ºå»


```

```c# 
TubeMoveAvailability BuildBaseAvailability(Tube tube, TubeState state)
{
    var remainingCapacity = tube.Capacity - state.FilledCount;

    int exportColor = state.TopColor;
    int exportCount = state.TopColorCount;

    int acceptColor = exportColor;
    int acceptCount = remainingCapacity;

    // ğŸ‘‡ å”¯ä¸€å…è®¸åˆ¤æ–­ TubeKind çš„åœ°æ–¹
    switch (tube.Kind)
    {
        case TubeKind.Fixed:
            exportCount = 0;
            acceptCount = 0;
            break;

        case TubeKind.Mono:
            acceptColor = tube.FixedColor;
            acceptCount = remainingCapacity;
            break;
    }

    return new TubeMoveAvailability(
        tube.Index,
        exportColor,
        exportCount,
        acceptCount,
        acceptColor,
        extra: null
    );
}
```

```text 
çœŸæ­£è¿˜æœ‰ä¼˜åŒ–ç©ºé—´çš„ç»´åº¦åªå‰© 4 ç±»ï¼š

A. å¯è¯æ˜çš„å¼±åŒæ„æŠ˜å ï¼ˆä¸ä¾èµ–å®Œå…¨ç­‰ä»·ï¼‰
B. çŠ¶æ€è¡¨ç¤ºçš„â€œä¿¡æ¯æœ€å°åŒ– + å»¶è¿Ÿå±•å¼€â€  ä¸è¦æŠŠè¾¹å…¨éƒ¨å±•å¼€ï¼Œä½¿ç”¨è¿­ä»£å™¨ï¼Œåªè®¡ç®—å¿…è¦çš„é‚£æ¬¡è®¡ç®—
C. è¾¹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆè¾¹ä¸æ˜¯ä¸€æ¬¡æ€§äº§ç‰©ï¼‰
D. æœç´¢è¿‡ç¨‹çš„â€œå½¢æ€æ§åˆ¶â€ï¼ˆä¸æ˜¯å‰ªæï¼‰


```
### é“å…·å…³å¡ç”Ÿæˆçš„å¯å‘å¼æ¢ç´¢




### TBSä¸‹é™åºåˆ—çš„å±•å¼€ => å…·ä½“ç§»åŠ¨åºåˆ—


### å‡ºé¢˜æ¨¡å¼çš„æ¢ç´¢