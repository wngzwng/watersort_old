水排序「障碍物 Obstacle」二维表（替代道具）

障碍物 = 盘面自带的机制 / 约束 / 环境因素
不是玩家主动使用的东西，而是关卡结构的一部分。

1）障碍物的核心定义维度（你系统里必须有的字段）

| 维度     | 名称（建议字段）              | 解释                   | 举例                                   |
| ------ | --------------------- | -------------------- | ------------------------------------ |
| 归属层级   | `ObstacleScope`       | 障碍物绑定在什么对象上          | Tube / Cell / Color / Global         |
| 影响类型   | `EffectType`          | 它改变了“移动规则”的哪一部分      | 禁倒入 / 禁倒出 / 改容量 / 改合并规则              |
| 触发时机   | `TriggerTiming`       | 何时生效（Move 前/后/生成移动时） | BeforeMove / AfterMove / ExploreMove |
| 激活条件   | `ActivationCondition` | 何时激活（可配置）            | 永久 / 计数 / 依赖状态                       |
| 状态变化   | `Statefulness`        | 障碍物本身会不会变            | Static / Dynamic                     |
| 优先级    | `Priority`            | 多障碍冲突时谁先算            | 100/200/…                            |
| 冲突策略   | `ConflictPolicy`      | 多个障碍同时作用怎么办          | Block / Override / Merge             |
| 可逆性    | `Reversible`          | 是否需要 Undo 支持         | Yes / No                             |
| Hash影响 | `HashAffect`          | 是否影响等价类去重            | Yes / No                             |


2）障碍物类型表（你关卡设计最常用的一层）

| 障碍名            | Scope | 影响类型     | 触发时机                  | 是否动态           | 对玩家观感    | 典型用途     |
| -------------- | ----- | -------- | --------------------- | -------------- | -------- | -------- |
| 封口瓶（不能倒出）      | Tube  | 禁倒出      | ExploreMove           | Static         | “这瓶被封住了” | 制造缓冲瓶不可用 |
| 吸附瓶（只能倒入不能倒出）  | Tube  | 禁倒出/限制倒出 | ExploreMove           | Static/Dynamic | “吸住了”    | 做陷阱/锁死策略 |
| 单向瓶（只能倒入/只能倒出） | Tube  | 方向限制     | ExploreMove           | Static         | “单向流动”   | 做拓扑结构关   |
| 容量压缩（容量-1）     | Tube  | 改容量      | ExploreMove/ApplyMove | Static         | “瓶子变矮”   | 增加碎片化难度  |
| 冻结瓶（若干步后解冻）    | Tube  | 禁倒出/禁倒入  | ExploreMove           | Dynamic        | “会解锁”    | 节奏控制     |

B. Cell级障碍（绑定某个格子位置）

| 障碍名          | Scope | 影响类型        | 触发时机                  | 是否动态           | 对玩家观感  | 典型用途         |
| ------------ | ----- | ----------- | --------------------- | -------------- | ------ | ------------ |
| 锁格（该格不可被倒入）  | Cell  | 禁倒入         | ExploreMove           | Static/Dynamic | “这里锁住” | 强制分流         |
| 粘格（倒入后不能倒出）  | Cell  | 禁倒出         | ExploreMove/AfterMove | Dynamic        | “粘住了”  | 形成不可逆陷阱      |
| 裂格（倒入后变空/消失） | Cell  | AfterMove变形 | AfterMove             | Dynamic        | “会破碎”  | 让颜色损耗、制造牺牲策略 |
| 传送格（倒入会换位置）  | Cell  | 重定向         | ApplyMove/AfterMove   | Dynamic        | “跳转”   | 结构谜题         |

C. Color级障碍（绑定颜色类别）

| 障碍名           | Scope | 影响类型  | 触发时机        | 是否动态    | 对玩家观感    | 典型用途   |
| ------------- | ----- | ----- | ----------- | ------- | -------- | ------ |
| 禁合并色（同色也不能合并） | Color | 改合并规则 | ExploreMove | Static  | “这颜色不稳定” | 反直觉关   |
| 重色（该色倒入消耗2格）  | Color | 改容量消耗 | ApplyMove   | Static  | “更重”     | 让局部更拥挤 |
| 变色（倒入后变成另一色）  | Color | 颜色变换  | AfterMove   | Dynamic | “会变”     | 机制关核心  |

D. Global级障碍（全局规则）

| 障碍名           | Scope  | 影响类型   | 触发时机        | 是否动态   | 对玩家观感     | 典型用途   |
| ------------- | ------ | ------ | ----------- | ------ | --------- | ------ |
| 限步数（N步内完成）    | Global | 限制搜索深度 | Global      | Static | “限时/限步挑战” | 快速局    |
| 限制空瓶数（空瓶不可用）  | Global | 资源约束   | ExploreMove | Static | “缓冲不足”    | 强化结构推演 |
| 反向规则（只能倒到不同色） | Global | 改倒水规则  | ExploreMove | Static | “反规则”     | 特殊玩法   |


3）触发时机表（你架构最关键的一维）
“移动前 / 应用移动 / 移动后 + 统一移动执行器 + 障碍物系统处理”

| 触发点        | 建议接口名                     | 负责什么               | 举例            |
| ---------- | ------------------------- | ------------------ | ------------- |
| 生成移动前      | `OnExploreMoves(state)`   | **剪枝 / 禁止某些 move** | 锁格：禁止倒入该格     |
| Move合法性判定  | `CanPour(from,to,amount)` | **规则约束**           | 封口瓶：from禁止倒出  |
| Move应用前    | `BeforeApply(move)`       | **记录快照/计数**        | 粘格：记录进入位置     |
| Move应用中    | `MutatePour(move)`        | **改写倒水效果**         | 传送格：改写目标      |
| Move应用后    | `AfterApply(move)`        | **产生二次效果**         | 裂格：倒入后消失      |
| Normalize前 | `BeforeNormalize(state)`  | **避免错误合并**         | 有障碍的单色瓶不能聚合   |
| Hash构建时    | `BuildObstacleKeyPart()`  | **去重依据的一部分**       | 障碍物状态必须进 hash |


4）冲突处理表（多个障碍叠加时必须明确）

| 冲突场景           | 规则建议            | 说明       |
| -------------- | --------------- | -------- |
| 同时“禁止倒入”+“重定向” | 先禁止后重定向         | 禁止是硬约束   |
| 同时“改容量”+“粘住”   | 先改容量后粘住         | 粘住依赖最终落点 |
| 多个禁止规则         | 任一禁止即禁止         | `AND` 逻辑 |
| 多个改写规则         | 按 Priority 顺序串联 | 形成“中间件链” |

5）最关心的：等价类 / Normalize / Hash 怎么处理？

障碍物会破坏“单色瓶聚合”等价性
单色瓶 A 无障碍，同色单色瓶 B 有障碍
A ↔ B 不能交换，否则去重错误。

所以应该在 TubeSignature 里加入：
ObstacleTag（静态类型）
ObstacleStateKey（动态状态，比如计数/开关）

结论：
障碍物参与 Hash
障碍物参与 Normalize-2 的“同类型单色瓶聚合”分类

6）一个最干净的分类命名
关卡类型（对外）
    无障碍关（Pure）
    障碍关（Obstacle）

系统层级（对内）
    Core（纯规则）
    Obstacle Layer（机制注入层）
    State Evolution（搜索层）